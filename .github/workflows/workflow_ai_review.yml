name: AI Code Reviewer

on:
  pull_request:
    types: [opened, synchronize] # PR이 열리거나 코드가 푸시될 때 실행

permissions:
  contents: read      # 코드 읽기 권한
  pull-requests: write # PR에 댓글 쓰기 권한

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # 기본적으로 현재와 이전 커밋만 가져옴

      # 2. 비교 대상인 Base Branch(예: main) 정보를 가져옴
      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1

      # 3. PR의 변경 사항(Diff) 추출
      - name: Get PR Diff
        id: get_diff
        run: |
          # FETCH_HEAD는 방금 fetch해온 대상을 가리킵니다.
          git diff FETCH_HEAD HEAD > pr_diff.txt
          echo "Diff extracted."

      # 3. Gemini API 호출 및 리뷰 생성
      - name: Request Review from Gemini
        id: gemini_request
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Diff 내용이 너무 크면 API 제한에 걸릴 수 있으므로 일부 전처리
          DIFF_CONTENT=$(cat pr_diff.txt | head -c 30000) # 최대 3만 자 제한
          
          # JSON 페이로드 생성 (jq를 사용해 안전하게 이스케이프)
          PROMPT="당신은 전문 소프트웨어 엔지니어입니다. 다음은 Pull Request의 변경 사항(diff)입니다. 코드의 버그, 가독성, 성능 개선 사항을 분석해서 한글로 친절하게 리뷰해 주세요.\n\n$DIFF_CONTENT"
          
          PAYLOAD=$(jq -n --arg msg "$PROMPT" '{contents: [{parts: [{text: $msg}]}]}')

          # Gemini API 호출
          RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")

          # 결과에서 텍스트만 추출 (jq 사용)
          REVIEW_TEXT=$(echo $RESPONSE | jq -r '.candidates[0].content.parts[0].text')
          
          # 결과를 파일로 저장 (환경 변수 크기 제한 방지)
          echo "$REVIEW_TEXT" > review_result.txt

      # 4. GitHub PR에 댓글 작성
      - name: Comment PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REVIEW_BODY=$(cat review_result.txt)
          # GitHub CLI(gh)를 사용하여 댓글 게시 (Ubuntu 환경에 기본 내장됨)
          gh pr comment ${{ github.event.pull_request.number }} --body "$REVIEW_BODY"