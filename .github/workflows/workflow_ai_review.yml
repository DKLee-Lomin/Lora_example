name: AI Code Reviewer

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ (ë³€ê²½ ì‚¬í•­ ë¹„êµë¥¼ ìœ„í•´ ì „ì²´ ì´ë ¥ ê°€ì ¸ì˜´)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. PRì˜ Diff(ë³€ê²½ ë‚´ìš©) ì¶”ì¶œ
      - name: Get PR Diff
        id: get_diff
        run: |
          # base ë¸Œëœì¹˜ì™€ head ë¸Œëœì¹˜ ì‚¬ì´ì˜ ë³€ê²½ ë‚´ì—­ì„ ì¶”ì¶œí•˜ì—¬ íŒŒì¼ë¡œ ì €ì¥
          git diff origin/${{ github.base_ref }}...origin/${{ github.head_ref }} > pr_diff.txt
          echo "diff_path=pr_diff.txt" >> $GITHUB_OUTPUT

      # 3. ChatGPT API í˜¸ì¶œ ë° ë¦¬ë·° ê²°ê³¼ ìƒì„±
      - name: Request Code Review from ChatGPT
        id: chatgpt
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Diff ë‚´ìš© ì½ê¸° (ë„ˆë¬´ í¬ë©´ API ì œí•œì— ê±¸ë¦´ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì ì ˆíˆ ì¡°ì ˆ í•„ìš”)
          DIFF_CONTENT=$(cat pr_diff.txt | head -c 10000) 
          
          # JSON ë³¸ë¬¸ ìƒì„± (jqë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬)
          PROMPT="You are a seasoned AI Engineer acting as a code reviewer. Your task is to analyze the provided Git-style unified code diffs and provide a review under the following guidelines:
            - Bug & Performance:
              Identify potential bugs, edge cases, and performance bottlenecks.
              If surrounding context is missing, clearly state assumptions and avoid speculative conclusions.
            - Quality & Clean Code:
              Evaluate readability, naming, structure, and adherence to Clean Code principles.
              Avoid purely subjective style preferences unless they affect maintainability or correctness.
            - Actionable Feedback:
              Provide concrete, improved code snippets for each suggested change.
            - Severity:
              Label each issue with one of: [Critical], [Major], [Minor], [Nit].
            - Output Format:
              Structure the review using the following sections:
              1. ğŸ”´ Potential Bugs
              2. âš¡ Performance Concerns
              3. ğŸ§¹ Code Quality & Clean Code
              4. âœ… Suggested Improvements (with code snippets)
            - Language:
              Write the entire review in Korean.
            - Exception:
              Skip any analysis of the `workflow_ai_review.yml` file entirely.\n\n$DIFF_CONTENT"
          
          # API í˜¸ì¶œ
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [{\"role\": \"user\", \"content\": \"$PROMPT\"}]
            }")

          # ê²°ê³¼ê°’ ì¶”ì¶œ (jq ì„¤ì¹˜ë˜ì–´ ìˆìŒ)
          REVIEW_TEXT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
          
          # ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥ (ë©€í‹°ë¼ì¸ ì¶œë ¥ì„ ìœ„í•´ íŒŒì¼ ì‚¬ìš© ê¶Œì¥)
          echo "$REVIEW_TEXT" > review_result.md

      # 4. PRì— ëŒ“ê¸€ ë‹¬ê¸°
      - name: Post Review Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT_BODY=$(cat review_result.md)
          
          # GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ ëŒ“ê¸€ ë“±ë¡
          curl -s -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "$(jq -n --arg body "$COMMENT_BODY" '{body: $body}')" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
