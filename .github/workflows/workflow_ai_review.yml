name: AI Code Reviewer

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read      # ì½”ë“œ ì½ê¸° ê¶Œí•œ
  pull-requests: write # PRì— ëŒ“ê¸€ ì“°ê¸° ê¶Œí•œ

jobs:
  review:
    # PRì— 'AI-Review'ë¼ëŠ” ë ˆì´ë¸”ì´ í¬í•¨ë˜ì–´ ìˆì„ ë•Œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    if: contains(github.event.pull_request.labels.*.name, 'ai_review')

    runs-on: [self-hosted, linux, x64]
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ (Shallow clone ë°©ì§€)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      # 2. ë¹„êµ ëŒ€ìƒì¸ Base Branch ì •ë³´ë¥¼ ê°€ì ¸ì˜´ (diff ì—ëŸ¬ ë°©ì§€)
      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1

      # 3. ë³€ê²½ ì‚¬í•­(Diff) ì¶”ì¶œ
      - name: Get PR Diff
        id: get_diff
        run: |
          # FETCH_HEAD(base)ì™€ HEAD(í˜„ì¬ PR) ê°„ì˜ ì°¨ì´ì  ì¶”ì¶œ
          git diff FETCH_HEAD HEAD > pr_diff.txt
          echo "Diff extracted successfully."

      # 4. Gemini API í˜¸ì¶œ ë° ë¦¬ë·° ìƒì„±
      - name: Request Review from Gemini
        id: gemini_request
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # í”„ë¡¬í”„íŠ¸ ìƒì„± (íŠ¹ìˆ˜ë¬¸ì ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ íŒŒì¼ë¡œ ì‘ì„±)
          echo "You are a seasoned AI Engineer acting as a code reviewer. Your task is to analyze the provided Git-style unified code diffs and provide a review under the following guidelines:
            - Bug & Performance:
              Identify potential bugs, edge cases, and performance bottlenecks.
              If surrounding context is missing, clearly state assumptions and avoid speculative conclusions.
            - Quality & Clean Code:
              Evaluate readability, naming, structure, and adherence to Clean Code principles.
              Avoid purely subjective style preferences unless they affect maintainability or correctness.
            - Actionable Feedback:
              Provide concrete, improved code snippets for each suggested change.
            - Severity:
              Label each issue with one of: [Critical], [Major], [Minor], [Nit].
            - Output Format:
              Structure the review using the following sections:
              1. ğŸ”´ Potential Bugs
              2. âš¡ Performance Concerns
              3. ğŸ§¹ Code Quality & Clean Code
              4. âœ… Suggested Improvements (with code snippets)
            - Language:
              Write the entire review in Korean.
            - Exception:
              Skip any analysis of the `workflow_ai_review.yml` file entirely." > prompt.txt
          echo -e "\n\n" >> prompt.txt
          head -c 30000 pr_diff.txt >> prompt.txt

          # jqì˜ --rawfileì„ ì‚¬ìš©í•˜ì—¬ JSON í˜ì´ë¡œë“œë¥¼ ì•ˆì „í•˜ê²Œ ìƒì„±
          jq -n --rawfile msg prompt.txt '{contents: [{parts: [{text: $msg}]}]}' > payload.json

          # API í˜¸ì¶œ ë° ì‘ë‹µ ì €ì¥
          RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=$GEMINI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @payload.json)

          # ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ ì¶œë ¥
          echo "Debug: Received response from Gemini API"
          
          # ê²°ê³¼ ì¶”ì¶œ (null ë˜ëŠ” ì—ëŸ¬ ì‘ë‹µ ì²˜ë¦¬)
          REVIEW_TEXT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')

          if [ -z "$REVIEW_TEXT" ] || [ "$REVIEW_TEXT" == "null" ]; then
            echo "Error: Gemini API ì‘ë‹µì´ ë¹„ì–´ìˆê±°ë‚˜ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."
            echo "Full Response for Debugging: $RESPONSE"
            exit 1
          fi

          echo "$REVIEW_TEXT" > review_result.txt

      # 5. GitHub PRì— ëŒ“ê¸€ ì‘ì„±
      - name: Comment PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # íŒŒì¼ì—ì„œ ë¦¬ë·° ë‚´ìš©ì„ ì½ì–´ PR ëŒ“ê¸€ë¡œ ê²Œì‹œ
          gh pr comment ${{ github.event.pull_request.number }} --body-file review_result.txt